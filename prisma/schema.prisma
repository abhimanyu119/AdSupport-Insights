generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("STORAGE_DATABASE_URL")
}

model AnalyticsRun {
  id          Int       @id @default(autoincrement())
  name        String
  source      RunSource
  platform    String?
  warnings    Json?
  rawPayload  Json?
  createdAt   DateTime  @default(now())

  campaignData CampaignData[]
  issueGroups IssueGroup[]
}

model CampaignData {
  id            Int       @id @default(autoincrement())
  runId         Int
  run           AnalyticsRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  campaign      String
  date          DateTime
  impressions   Int
  clicks        Int
  spend         Decimal
  conversions   Int

  issueOccurrences  IssueOccurrence[]
  createdAt     DateTime @default(now())

  @@index([runId])
  @@index([campaign, date])
}

model IssueGroup {
  id         Int       @id @default(autoincrement())
  runId      Int
  run        AnalyticsRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  campaign   String
  type       IssueType
  severity   IssueSeverity
  status     IssueStatus @default(OPEN)

  occurrences IssueOccurrence[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([runId, campaign, type])
}

model IssueOccurrence {
  id            Int       @id @default(autoincrement())
  issueGroupId  Int
  issueGroup    IssueGroup @relation(fields: [issueGroupId], references: [id], onDelete: Cascade)

  campaignDataId Int
  campaignData   CampaignData @relation(fields: [campaignDataId], references: [id], onDelete: Cascade)

  notes         String
  date          DateTime

  createdAt     DateTime @default(now())

  @@unique([issueGroupId, campaignDataId])
}


enum RunSource {
  CSV
  API
}

enum IssueType {
  ZERO_IMPRESSIONS
  HIGH_SPEND_NO_CONVERSIONS
  SUDDEN_DROP_IMPRESSIONS
  LOW_CTR
}

enum IssueSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  INVESTIGATING
  RESOLVED
}
