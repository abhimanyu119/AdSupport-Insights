generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("STORAGE_DATABASE_URL")
}

model AnalyticsRun {
  id          Int       @id @default(autoincrement())
  name        String
  source      RunSource
  platform    String?
  warnings    Json?
  rawPayload  Json?
  createdAt   DateTime  @default(now())

  campaignData CampaignData[]
}

model CampaignData {
  id            Int       @id @default(autoincrement())
  runId         Int
  run           AnalyticsRun @relation(fields: [runId], references: [id], onDelete: Cascade)

  campaign      String
  date          DateTime
  impressions   Int
  clicks        Int
  spend         Decimal
  conversions   Int

  issues        Issue[]
  createdAt     DateTime @default(now())

  @@index([runId])
  @@index([campaign, date])
}

model Issue {
  id             Int       @id @default(autoincrement())
  campaignDataId Int
  campaignData   CampaignData @relation(fields: [campaignDataId], references: [id], onDelete: Cascade)

  type           IssueType
  severity       IssueSeverity
  status         IssueStatus @default(OPEN)
  notes          String

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([campaignDataId, type])
}

enum RunSource {
  CSV
  API
}

enum IssueType {
  ZERO_IMPRESSIONS
  HIGH_SPEND_NO_CONVERSIONS
  SUDDEN_DROP_IMPRESSIONS
  LOW_CTR
}

enum IssueSeverity {
  CRITICAL
  HIGH
  MEDIUM
  LOW
}

enum IssueStatus {
  OPEN
  INVESTIGATING
  RESOLVED
}
